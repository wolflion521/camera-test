<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iPhone 17 å®æ—¶è§†é¢‘æµ VLM ç›‘æ§</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #000;
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: white;
            overflow: hidden;
        }

        /* è§†é¢‘åŒºåŸŸ */
        .video-wrapper {
            flex: 1;
            position: relative;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* å®æ—¶ç›‘æ§çš„çº¢ç‚¹åŠ¨ç”» */
        @keyframes blink { 50% { opacity: 0; } }
        .recording-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            animation: blink 1s infinite;
            margin-right: 5px;
            vertical-align: middle;
            display: none; /* é»˜è®¤éšè— */
        }

        /* æ‚¬æµ®ä¿¡æ¯é¢æ¿ */
        .hud-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            padding: 15px;
            border-radius: 12px;
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .hud-header {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }

        #ai-result {
            font-size: 18px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px black;
            min-height: 24px;
        }

        #fps-counter {
            font-family: monospace;
            color: #00ff00;
        }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .controls {
            background: rgba(20, 20, 20, 0.95);
            padding: 20px 20px 40px 20px; /* åº•éƒ¨ç•™å¤šç‚¹ç»™ iPhone Home æ¡ */
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-top: 1px solid #333;
            z-index: 20;
        }

        .row { display: flex; gap: 10px; }

        button {
            padding: 14px;
            font-size: 16px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            transition: all 0.2s;
        }

        .btn-primary { background: #007AFF; color: white; }
        .btn-success { background: #34C759; color: white; }
        .btn-danger { background: #FF3B30; color: white; }
        .btn-stop { background: #FF453A; color: white; border: 2px solid #FF453A; }
        
        button:disabled { opacity: 0.4; cursor: not-allowed; }

        /* è¿›åº¦æ¡ */
        .progress-container {
            height: 4px;
            background: #333;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 5px;
        }
        .progress-bar {
            height: 100%;
            background: #0A84FF;
            width: 0%;
            transition: width 0.2s;
        }

    </style>
</head>
<body>

    <div class="video-wrapper">
        <video id="video" autoplay playsinline muted></video>
        
        <div class="hud-overlay">
            <div class="hud-header">
                <span><div id="rec-dot" class="recording-indicator"></div>AI ç›‘æ§ä¸­</span>
                <span id="fps-counter">Latency: -- ms</span>
            </div>
            <div id="ai-status" style="font-size: 12px; color: #888; margin-bottom: 4px;">ç­‰å¾…æ¨¡å‹åŠ è½½...</div>
            <div id="ai-result">---</div>
            <div class="progress-container"><div id="load-progress" class="progress-bar"></div></div>
        </div>
    </div>

    <div class="controls">
        <div class="row">
            <button id="camBtn" class="btn-primary" onclick="toggleCamera()">å¼€å¯ç›¸æœº</button>
        </div>
        <div class="row">
            <button id="loadBtn" class="btn-success" onclick="initWebLLM()">1. åŠ è½½å¤§è„‘ (2.2GB)</button>
            <button id="monitorBtn" class="btn-primary" onclick="toggleMonitoring()" disabled>2. å¼€å§‹å®æ—¶ç›‘æ§</button>
        </div>
    </div>

    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        // é…ç½®ï¼šä½¿ç”¨ Phi-3.5 Vision (é€Ÿåº¦æœ€å¿«)
        const selectedModel = "Phi-3.5-vision-instruct-q4f16_1-MLC";
        
        let engine = null;
        let isMonitoring = false;
        let isInferencing = false; // æ¨ç†é”ï¼šé˜²æ­¢å¹¶å‘
        
        // 1. åˆå§‹åŒ–æ¨¡å‹
        window.initWebLLM = async function() {
            const loadBtn = document.getElementById('loadBtn');
            const statusLabel = document.getElementById('ai-status');
            const progressBar = document.getElementById('load-progress');
            const monitorBtn = document.getElementById('monitorBtn');

            if (engine) return; // é˜²æ­¢é‡å¤ç‚¹

            loadBtn.disabled = true;
            loadBtn.innerText = "ä¸‹è½½ä¸­...";
            statusLabel.innerText = "æ­£åœ¨åˆå§‹åŒ– WebGPU...";

            try {
                engine = await webllm.CreateMLCEngine(
                    selectedModel,
                    { 
                        initProgressCallback: (report) => {
                            statusLabel.innerText = report.text;
                            if(report.progress) {
                                progressBar.style.width = (report.progress * 100) + "%";
                            }
                        }
                    }
                );

                statusLabel.innerText = "æ¨¡å‹å°±ç»ªã€‚ç©ºé—²ã€‚";
                statusLabel.style.color = "#4CAF50";
                loadBtn.innerText = "AI å·²å°±ç»ª";
                progressBar.style.width = "100%";
                
                monitorBtn.disabled = false;
                monitorBtn.classList.remove('btn-primary');
                monitorBtn.classList.add('btn-success');

            } catch (err) {
                console.error(err);
                statusLabel.innerText = "åŠ è½½å¤±è´¥: " + err.message;
                loadBtn.innerText = "é‡è¯•";
                loadBtn.disabled = false;
            }
        };

        // 2. ç›‘æ§å¾ªç¯é€»è¾‘ (æ ¸å¿ƒä¿®æ”¹)
        window.toggleMonitoring = function() {
            const btn = document.getElementById('monitorBtn');
            const dot = document.getElementById('rec-dot');
            
            if (!isMonitoring) {
                // å¼€å¯ç›‘æ§
                isMonitoring = true;
                btn.innerText = "åœæ­¢ç›‘æ§";
                btn.classList.remove('btn-success');
                btn.classList.add('btn-stop');
                dot.style.display = "inline-block";
                
                // å¯åŠ¨å¾ªç¯
                runInferenceLoop();
                
            } else {
                // åœæ­¢ç›‘æ§
                isMonitoring = false;
                btn.innerText = "2. å¼€å§‹å®æ—¶ç›‘æ§";
                btn.classList.remove('btn-stop');
                btn.classList.add('btn-success');
                dot.style.display = "none";
                document.getElementById('ai-status').innerText = "ç›‘æ§å·²æš‚åœ";
            }
        };

        // é€’å½’å¾ªç¯å‡½æ•°
        async function runInferenceLoop() {
            if (!isMonitoring) return;

            // å¦‚æœä¸Šä¸€å¸§è¿˜åœ¨ç®—ï¼Œå°±è·³è¿‡è¿™ä¸€å¸§ï¼Œé˜²æ­¢å¡æ­»
            if (isInferencing) {
                requestAnimationFrame(runInferenceLoop);
                return;
            }

            const statusLabel = document.getElementById('ai-status');
            const resultLabel = document.getElementById('ai-result');
            const fpsLabel = document.getElementById('fps-counter');
            const video = document.getElementById('video');

            // æ£€æŸ¥è§†é¢‘æ˜¯å¦å‡†å¤‡å¥½
            if (!video.videoWidth) {
                requestAnimationFrame(runInferenceLoop);
                return;
            }

            try {
                isInferencing = true; // ä¸Šé”
                const startTime = performance.now();
                statusLabel.innerText = "ğŸ‘€ æ­£åœ¨è§‚å¯Ÿ...";

                // --- æˆªå¸§ ---
                const canvas = document.createElement('canvas');
                // é™ä½åˆ†è¾¨ç‡ä»¥æé«˜é€Ÿåº¦ (æ‰‹æœºç«¯å»ºè®®ä¸è¦è¶…è¿‡ 640x480)
                canvas.width = 640; 
                canvas.height = 480;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.5); // 50% è´¨é‡å‹ç¼©

                // --- æ„é€  Prompt ---
                // å…³é”®ï¼šä¿æŒ Prompt ç®€çŸ­ï¼Œä¸” JSON æ ¼å¼æ–¹ä¾¿è§£æ
                const messages = [
                    {
                        role: "user",
                        content: [
                            { 
                                type: "text", 
                                text: "Analyze image. Is child safe? Format: [SAFE] or [DANGER] reason." 
                            },
                            { 
                                type: "image_url", 
                                image_url: { url: dataUrl } 
                            }
                        ]
                    }
                ];

                // --- æ¨ç† ---
                const reply = await engine.chat.completions.create({
                    messages,
                    temperature: 0.0, // 0.0 æœ€ç¨³å®š
                    max_tokens: 64,   // æçŸ­è¾“å‡ºï¼Œåªæ±‚ç»“æœ
                });

                const text = reply.choices[0].message.content;
                
                // --- æ›´æ–° UI ---
                const endTime = performance.now();
                const latency = Math.round(endTime - startTime);
                
                fpsLabel.innerText = `Latency: ${latency}ms`;
                resultLabel.innerText = text;

                if (text.toUpperCase().includes("DANGER") || text.toUpperCase().includes("UNSAFE")) {
                    resultLabel.style.color = "#FF3B30"; // çº¢è‰²è­¦å‘Š
                } else {
                    resultLabel.style.color = "#34C759"; // ç»¿è‰²å®‰å…¨
                }

            } catch (err) {
                console.error(err);
                resultLabel.innerText = "Error: " + err.message;
            } finally {
                isInferencing = false; // è§£é”
                
                // ç­–ç•¥ï¼šæ ¹æ®æ€§èƒ½è‡ªåŠ¨è°ƒèŠ‚
                // å¦‚æœä½ æƒ³è®©æ‰‹æœºä¼‘æ¯ä¸€ä¸‹ï¼Œå¯ä»¥åœ¨è¿™é‡ŒåŠ  setTimeout
                // ç›®å‰é€»è¾‘æ˜¯ï¼šç®—å®Œè¿™ä¸€å¸§ï¼Œç«‹åˆ»ç®—ä¸‹ä¸€å¸§ (å…¨åŠ›è·‘)
                if (isMonitoring) {
                    // ç•™ 500ms å†·å´æ—¶é—´ï¼Œé˜²æ­¢æ‰‹æœºè¿‡çƒ­
                    setTimeout(runInferenceLoop, 500); 
                }
            }
        }

        // æ‘„åƒå¤´é€»è¾‘ (ä¿æŒä¸å˜)
        const videoElement = document.getElementById('video');
        const camBtn = document.getElementById('camBtn');
        let stream = null;

        window.toggleCamera = async function() {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                videoElement.srcObject = null;
                stream = null;
                camBtn.innerText = "å¼€å¯ç›¸æœº";
                camBtn.classList.remove('btn-danger');
                camBtn.classList.add('btn-primary');
                return;
            }
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                videoElement.srcObject = stream;
                camBtn.innerText = "å…³é—­ç›¸æœº";
                camBtn.classList.remove('btn-primary');
                camBtn.classList.add('btn-danger');
            } catch (e) {
                alert("ç›¸æœºæƒé™å¤±è´¥");
            }
        }
    </script>
</body>
</html>