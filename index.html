<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>云端视频分析 (仿微信)</title>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
        
        .video-container { 
            flex: 1; position: relative; background: #222; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        .status-badge {
            position: absolute; top: 20px; left: 20px;
            background: rgba(0,0,0,0.6); padding: 8px 15px;
            border-radius: 20px; font-size: 14px;
            display: flex; align-items: center; gap: 8px;
        }
        .dot { width: 10px; height: 10px; background: #ccc; border-radius: 50%; }
        .dot.recording { background: red; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        .result-panel {
            min-height: 100px; padding: 20px; background: #1a1a1a;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
        }
        #result-text { font-size: 16px; color: #ddd; line-height: 1.5; }

        .controls {
            padding: 20px; background: #1a1a1a;
            display: flex; flex-direction: column; gap: 10px;
        }
        
        /* 长按录制按钮 */
        #recordBtn {
            width: 80px; height: 80px; border-radius: 50%;
            background: white; border: 4px solid #ccc;
            margin: 0 auto; display: block;
            transition: all 0.2s;
            /* 防止长按选中文本 */
            user-select: none; -webkit-user-select: none; 
            touch-action: manipulation;
        }
        #recordBtn.active { background: #007AFF; transform: scale(1.1); }
        
        .hint { text-align: center; color: #888; font-size: 12px; margin-bottom: 10px; }
        
        input { padding: 10px; border-radius: 8px; border: none; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="video-container">
        <video id="preview" autoplay playsinline muted></video>
        <div class="status-badge">
            <div id="status-dot" class="dot"></div>
            <span id="status-text">准备就绪</span>
        </div>
    </div>

    <div class="result-panel">
        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">AI 分析结果:</div>
        <div id="result-text">长按下方按钮录制视频 (5秒以上)，松开后自动分析。</div>
    </div>

    <div class="controls">
        <input type="text" id="serverIp" placeholder="输入电脑IP，如 192.168.1.5:8000" value="192.168.1.X:8000">
        <p class="hint">按住录像，松开发送</p>
        <div id="recordBtn"></div>
    </div>

    <script>
        const preview = document.getElementById('preview');
        const recordBtn = document.getElementById('recordBtn');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const resultText = document.getElementById('result-text');
        
        let mediaRecorder;
        let recordedChunks = [];
        let stream;

        // 1. 启动摄像头
        async function initCamera() {
            try {
                // 关键优化：限制分辨率，实现类似微信的压缩效果
                stream = await navigator.mediaDevices.getUserMedia({
                    audio: false, // VLM 暂时不需要声音，省流量
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 480 }, // 480p 足够且文件小
                        height: { ideal: 640 },
                        frameRate: { max: 15 } // 15帧省流量
                    }
                });
                preview.srcObject = stream;
            } catch (err) {
                alert("摄像头启动失败: " + err.message);
            }
        }
        initCamera();

        // 2. 录制逻辑
        function startRecording() {
            recordedChunks = [];
            // 根据浏览器选择最优格式
            const mimeType = MediaRecorder.isTypeSupported("video/webm;codecs=vp9") 
                           ? "video/webm;codecs=vp9" 
                           : "video/mp4";

            // 关键优化：限制码率 500kbps (500000 bps)
            const options = { mimeType: mimeType, videoBitsPerSecond: 500000 };
            
            try {
                mediaRecorder = new MediaRecorder(stream, options);
            } catch (e) {
                // 回退兼容 Safari
                mediaRecorder = new MediaRecorder(stream);
            }

            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) recordedChunks.push(event.data);
            };

            mediaRecorder.onstop = uploadVideo;
            mediaRecorder.start();
            
            recordBtn.classList.add('active');
            statusDot.classList.add('recording');
            statusText.innerText = "录制中...";
            resultText.innerText = "正在录制...";
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                recordBtn.classList.remove('active');
                statusDot.classList.remove('recording');
                statusText.innerText = "处理中...";
            }
        }

        // 3. 上传逻辑
        async function uploadVideo() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            
            // 显示文件大小，让你放心
            const sizeKB = (blob.size / 1024).toFixed(1);
            resultText.innerText = `录制完成 (${sizeKB} KB)，正在上传云端分析...`;

            const formData = new FormData();
            formData.append('file', blob, 'video.webm');

            const ip = document.getElementById('serverIp').value;
            if (ip.includes('X')) {
                alert("请先填入电脑的 IP 地址！");
                return;
            }

            try {
                const startTime = Date.now();
                const response = await fetch(`https://${ip}/upload_and_analyze`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                const duration = ((Date.now() - startTime) / 1000).toFixed(1);

                if (data.status === 'success') {
                    resultText.innerHTML = `<span style="color:#4CAF50">✅ 分析完成 (${duration}s)</span><br>${data.result}`;
                    statusText.innerText = "就绪";
                } else {
                    resultText.innerText = "❌ 错误: " + data.result;
                    statusText.innerText = "出错";
                }

            } catch (err) {
                resultText.innerText = "网络请求失败: " + err.message;
                statusText.innerText = "断开";
            }
        }

        // 4. 绑定按钮事件 (兼容手机触摸)
        recordBtn.addEventListener('mousedown', startRecording);
        recordBtn.addEventListener('mouseup', stopRecording);
        recordBtn.addEventListener('mouseleave', stopRecording);
        
        recordBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startRecording(); });
        recordBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopRecording(); });

    </script>
</body>
</html>